<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ—¥æœ¬åŒè¡ŒåŒæ­¥åŠ©æ‰‹</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- æ›¿æ›æˆä½ çš„ Firebase é…ç½® ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // ------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const activeTab = ref('itinerary');
                const itinerary = ref([]);
                const fxRate = ref(0.215);
                const taxRate = ref(10);
                const taxInput = ref(null);
                const bill = ref({ amount: null, people: 1 });
                const syncStatus = ref('connecting'); // connecting, synced, saving

                // é›²ç«¯è³‡æ–™ ID (å¦‚æœæ˜¯ä¸åŒåœ˜é«”ï¼Œå¯ä»¥ä¿®æ”¹é€™å€‹ ID)
                const tripId = "japan_trip_2026_shared";
                const tripRef = doc(db, "trips", tripId);

                // 1. å³æ™‚ç›£è½é›²ç«¯è³‡æ–™ (å¤§å®¶çœ‹åŒä¸€ä»½)
                onMounted(() => {
                    onSnapshot(tripRef, (snapshot) => {
                        if (snapshot.exists()) {
                            const data = snapshot.data();
                            itinerary.value = data.itinerary || [];
                            fxRate.value = data.fxRate || 0.215;
                        } else {
                            // åˆå§‹åŒ–è³‡æ–™åº«
                            setDoc(tripRef, { itinerary: [], fxRate: 0.215 });
                        }
                        syncStatus.value = 'synced';
                    }, (error) => {
                        console.error("åŒæ­¥å¤±æ•—:", error);
                        syncStatus.value = 'error';
                    });
                });

                // 2. æœ¬åœ°ä¿®æ”¹å¾ŒåŒæ­¥è‡³é›²ç«¯ (Debounce é˜²æŠ–)
                let timer;
                const syncData = () => {
                    syncStatus.value = 'saving';
                    clearTimeout(timer);
                    timer = setTimeout(async () => {
                        try {
                            await updateDoc(tripRef, {
                                itinerary: JSON.parse(JSON.stringify(itinerary.value)),
                                fxRate: fxRate.value
                            });
                            syncStatus.value = 'synced';
                        } catch (e) {
                            console.error("æ›´æ–°å¤±æ•—:", e);
                        }
                    }, 500); 
                };

                const addItinerary = () => {
                    itinerary.value.push({ time: "09:00", location: "", note: "" });
                    syncData();
                };

                const deleteItinerary = (idx) => {
                    if(confirm('åˆªé™¤é€™é …è¡Œç¨‹ï¼Ÿ')) {
                        itinerary.value.splice(idx, 1);
                        syncData();
                    }
                };

                const taxRefunded = computed(() => {
                    if (!taxInput.value) return { total: 0, saved: 0 };
                    const original = taxInput.value / (1 + taxRate.value / 100);
                    return { total: Math.round(original), saved: Math.round(taxInput.value - original) };
                });

                const openMap = (l) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(l)}`, '_blank');
                
                const openAllMap = () => {
                    const locs = itinerary.value.map(i => i.location).filter(l => l);
                    if (!locs.length) return alert("è«‹å…ˆè¼¸å…¥åœ°é»");
                    const waypoints = locs.slice(0, -1).map(l => encodeURIComponent(l)).join('|');
                    window.open(`https://www.google.com/maps/dir/?api=1&origin=Current+Location&destination=${encodeURIComponent(locs[locs.length-1])}&waypoints=${waypoints}&travelmode=transit`, '_blank');
                };

                return {
                    activeTab, itinerary, bill, fxRate, taxRate, taxInput, taxRefunded, syncStatus,
                    addItinerary, deleteItinerary, syncData, openMap, openAllMap
                };
            }
        }).mount('#app');
    </script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: #F2F2F7; }
        .app-card { background: white; border-radius: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .glass-nav { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); border-top: 1px solid rgba(0,0,0,0.05); }
        input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(30%) sepia(100%) saturate(2000%) hue-rotate(340deg); }
    </style>
</head>
<body class="antialiased select-none">

<div id="app" class="max-w-md mx-auto min-h-screen relative pb-32">
    
    <header class="p-6 sticky top-0 bg-[#F2F2F7]/90 backdrop-blur-md z-[100] flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-black text-gray-900 leading-tight">Live Sync Trip</h1>
            <div class="flex items-center gap-1.5 mt-1">
                <div :class="['w-2 h-2 rounded-full', syncStatus === 'synced' ? 'bg-green-500' : 'bg-orange-400 animate-pulse']"></div>
                <span class="text-[10px] font-bold text-gray-400 tracking-widest uppercase">
                    {{ syncStatus === 'synced' ? 'å·²å³æ™‚åŒæ­¥' : 'é›²ç«¯æ›´æ–°ä¸­' }}
                </span>
            </div>
        </div>
        <button v-if="activeTab === 'itinerary'" @click="addItinerary" class="w-12 h-12 bg-gray-900 text-white rounded-2xl shadow-xl active:scale-90 transition">
            <i class="fas fa-plus"></i>
        </button>
    </header>

    <main class="px-5">
        
        <div v-if="activeTab === 'itinerary'" class="space-y-4 animate-fade-in">
            <button @click="openAllMap" class="w-full bg-blue-600 p-4 rounded-3xl text-white font-bold shadow-lg shadow-blue-100 active:scale-95 transition">
                ğŸ—ºï¸ ç¾¤çµ„åœ°åœ–ï¼šé‡˜é¸æ‰€æœ‰åœ°é»
            </button>

            <div v-for="(item, index) in itinerary" :key="index" class="app-card p-5 border border-transparent focus-within:border-red-100 transition">
                <div class="flex gap-4">
                    <div class="flex flex-col items-center">
                        <input v-model="item.time" @input="syncData" type="time" class="font-bold text-red-600 text-sm bg-transparent outline-none">
                        <div class="w-[2px] h-full bg-gray-50 my-2"></div>
                        <button @click="deleteItinerary(index)" class="text-gray-200 hover:text-red-400"><i class="fas fa-trash-can"></i></button>
                    </div>
                    <div class="flex-1">
                        <input v-model="item.location" @input="syncData" placeholder="è¡Œç¨‹åç¨±" class="w-full font-black text-gray-800 text-lg outline-none placeholder:text-gray-200">
                        <input v-model="item.note" @input="syncData" placeholder="çµ¦æ—…ä¼´çš„å‚™è¨»..." class="w-full text-xs text-gray-400 mt-1 outline-none bg-transparent">
                        <div class="mt-3 flex gap-2">
                            <button @click="openMap(item.location)" class="px-3 py-1 bg-gray-100 text-gray-500 text-[10px] font-bold rounded-lg uppercase">åœ°åœ–å°èˆª</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'finance'" class="space-y-6">
            <div class="bg-gray-900 rounded-[2.5rem] p-7 text-white shadow-2xl relative overflow-hidden">
                <div class="flex justify-between mb-8">
                    <span class="text-[10px] font-black tracking-widest text-yellow-500 uppercase">Tax Refund</span>
                    <div class="flex items-center gap-1 bg-white/10 px-3 py-1 rounded-full text-xs">
                        <input v-model.number="taxRate" class="w-6 bg-transparent text-center focus:outline-none font-bold"><span>%</span>
                    </div>
                </div>
                <input v-model.number="taxInput" type="number" class="w-full bg-transparent text-5xl font-light outline-none mb-6" placeholder="Â¥ 0">
                <div class="grid grid-cols-2 pt-6 border-t border-white/10">
                    <div>
                        <p class="text-[10px] text-gray-500 uppercase font-bold">é€€ç¨…å¾Œ</p>
                        <p class="text-xl font-bold">Â¥ {{ taxRefunded.total }}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-gray-500 uppercase font-bold">çœä¸‹å°å¹£</p>
                        <p class="text-xl font-bold text-yellow-500">$ {{ Math.round(taxRefunded.saved * fxRate) }}</p>
                    </div>
                </div>
            </div>

            <div class="app-card p-8">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="font-black text-gray-900">ç¾¤çµ„è²»ç”¨åŒæ­¥</h3>
                    <div class="text-right">
                        <p class="text-[9px] text-gray-400 font-bold">å…¬ç”¨åŒ¯ç‡</p>
                        <input v-model.number="fxRate" @input="syncData" step="0.001" type="number" class="w-16 text-right font-black text-red-600 outline-none">
                    </div>
                </div>
                <div class="space-y-5">
                    <input v-model.number="bill.amount" type="number" class="w-full p-4 bg-gray-50 rounded-2xl text-xl font-bold outline-none" placeholder="è¼¸å…¥ç¸½é¡ (JPY)">
                    <input v-model.number="bill.people" type="number" class="w-full p-4 bg-gray-50 rounded-2xl text-xl font-bold outline-none" placeholder="åˆ†æ”¤äººæ•¸">
                    <div v-if="bill.amount" class="p-6 bg-red-600 text-white rounded-[2rem] text-center shadow-lg shadow-red-100">
                        <p class="text-xs opacity-70 mb-1">æ¯äººæ‡‰ä»˜å°å¹£</p>
                        <p class="text-4xl font-black">$ {{ Math.round((bill.amount * fxRate) / (bill.people || 1)) }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'tool'" class="space-y-4">
            <a href="https://www.deepl.com/translator#zh/ja/" target="_blank" class="app-card p-6 flex items-center justify-between active:bg-gray-50 transition">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center text-2xl"><i class="fas fa-language"></i></div>
                    <div><h4 class="font-black">DeepL ç¿»è­¯</h4><p class="text-xs text-gray-400">ç›®å‰æœ€å¼·çš„æ—¥æ–‡ç¿»è­¯</p></div>
                </div>
                <i class="fas fa-chevron-right text-gray-200"></i>
            </a>
        </div>

    </main>

    <nav class="fixed bottom-0 inset-x-0 h-24 glass-nav flex justify-around items-center px-10 z-[100]">
        <button @click="activeTab = 'itinerary'" :class="['flex flex-col items-center gap-1 transition-all', activeTab === 'itinerary' ? 'text-red-600 scale-110' : 'text-gray-300']">
            <i class="fas fa-compass text-xl"></i><span class="text-[9px] font-black uppercase">Itinerary</span>
        </button>
        <button @click="activeTab = 'finance'" :class="['flex flex-col items-center gap-1 transition-all', activeTab === 'finance' ? 'text-red-600 scale-110' : 'text-gray-300']">
            <i class="fas fa-wallet text-xl"></i><span class="text-[9px] font-black uppercase">Finance</span>
        </button>
        <button @click="activeTab = 'tool'" :class="['flex flex-col items-center gap-1 transition-all', activeTab === 'tool' ? 'text-red-600 scale-110' : 'text-gray-300']">
            <i class="fas fa-grid-2 text-xl"></i><span class="text-[9px] font-black uppercase">Tools</span>
        </button>
    </nav>
</div>

</body>
</html>
